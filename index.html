<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cost Mapping Input — Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --slb-blue-800:#002b7f; --slb-blue-700:#0033a0; --slb-blue-050:#eaf1ff;
      --muted:#6b7280; --border:#e5e7eb; --bg:#f8fafc; --warn:#ea580c;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      color:#111827; background:var(--bg);
    }
    header{
      background:linear-gradient(120deg,var(--slb-blue-800),var(--slb-blue-700));
      color:#fff; padding:20px 16px; border-bottom:4px solid rgba(255,255,255,.08);
    }
    header .title{font-weight:700; font-size:clamp(22px,3vw,28px); letter-spacing:.2px}
    header .subtitle{opacity:.9; margin-top:4px; font-size:14px}

    .container{
      max-width:1200px; margin:18px auto; padding:0 16px;
      display:grid; grid-template-columns: 420px 1fr; gap:18px;
    }
    @media (max-width:900px){ .container{ grid-template-columns: 1fr; } }

    /* Left: selector tree (pretty indented list) */
    .panel{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .panel h3{
      margin:0; padding:12px 14px 6px; font-size:14px; color:var(--muted); font-weight:600;
    }
    .tree{ padding:6px 10px 12px; }

    /* Nodes */
    .node{ display:flex; align-items:center; gap:10px; padding:6px 8px; border-radius:10px; }
    .node:hover{ background:var(--slb-blue-050); }
    .node input[type="checkbox"]{ width:18px; height:18px; }
    .node label{ flex:1; cursor:pointer; }
    .lvl-0{ font-weight:800; }
    .lvl-1{ font-weight:700; padding-left:8px; }
    .lvl-2{ padding-left:28px; position:relative; }
    .lvl-2::before{
      content:""; position:absolute; left:16px; top:0; bottom:0; width:2px; background:var(--border);
      border-radius:2px;
    }
    .disabled label{ color:#9ca3af; }
    .disabled{ opacity:.75 }
    .small{ font-size:12px; color:#475569; margin:6px 10px 10px 10px }

    /* Collapsible groups */
    .group{ margin:0; padding:0; }
    .group .children{ display:block; }
    .group[aria-expanded="false"] .children{ display:none; }
    .twisty{
      width:16px; flex:0 0 16px; text-align:center; cursor:pointer; user-select:none;
      color:#475569; font-size:12px;
    }
    .twisty:focus{ outline:2px solid #c7d2fe; border-radius:4px; }
    .group[aria-expanded="true"] .twisty{ transform:rotate(90deg); }

    /* Right: mapping */
    .map-panel{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); overflow:hidden }
    .map-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border) }
    .map-head h3{ margin:0; font-size:15px }
    .actions{ display:flex; gap:8px; align-items:center }
    button,.link{
      border:1px solid var(--slb-blue-700); background:var(--slb-blue-700); color:#fff; padding:8px 10px; border-radius:10px;
      font-weight:600; cursor:pointer; font-size:13px;
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .link{ background:transparent; color:#0033a0 }
    .table{ width:100%; border-collapse:collapse; }
    .table th,.table td{ padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; font-size:13px }
    .table th{ background:#fafafa; color:var(--muted); }
    select{
      width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; font:inherit;
    }
    .hint{ font-size:12px; color:var(--muted); padding:8px 12px }
    .error{ color:#ea580c; font-size:12px; margin-top:6px; padding:0 12px 12px }

    .pill{
      display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:11px; font-weight:700;
      border:1px solid #e5e7eb; vertical-align:middle;
    }

    /* Log panel */
    .log{ border-top:1px dashed var(--border); background:#fafafa; }
    .log-head{ display:flex; align-items:center; gap:8px; padding:8px 12px; cursor:pointer; user-select:none; font-weight:700; color:#374151; }
    .chev{ transition:transform .18s ease; }
    .log[aria-expanded="true"] .chev{ transform:rotate(90deg); }
    .log-body{ display:none; padding:0 12px 12px; }
    .log[aria-expanded="true"] .log-body{ display:block; }
    pre{
      margin:0; padding:10px; background:#0b1220; color:#e5e7eb; border-radius:10px; overflow:auto; border:1px solid #111827;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; line-height:1.45;
      max-height:180px;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">Cost Mapping Input</div>
    <div class="subtitle">Prototype Input page</div>
  </header>

  <main class="container">
    <!-- Left: checkbox tree -->
    <section class="panel" aria-label="Field selector">
      <h3>Select fields to map</h3>
      <div id="tree" class="tree"></div>
      <div class="small">
        Rules: <span class="pill">Total Capex</span> disables everything else. Any <span class="pill">Total …</span> disables only its own children.
        You can select multiple totals independently. Click ▶ to expand children.
      </div>
    </section>

    <!-- Right: mapping table + actions -->
    <section class="map-panel" aria-label="Mapping">
      <div class="map-head">
        <h3>Mappings <span id="selCount" class="pill">0 selected</span></h3>
        <div class="actions">
          <button id="downloadBtn" disabled>Download JSON</button>
          <button class="link" id="resetBtn" type="button" title="Restore defaults">Reset</button>
        </div>
      </div>
      <table class="table" id="mapTable" role="table" aria-label="Selected fields to map">
        <thead><tr><th style="width:45%">Field</th><th>Category</th></tr></thead>
        <tbody id="mapBody"><tr><td colspan="2" class="hint">Select items on the left to begin.</td></tr></tbody>
      </table>
      <div id="errors" class="error" aria-live="polite"></div>

      <!-- Log (collapsed by default) -->
      <div id="log" class="log" aria-expanded="false">
        <div id="logHead" class="log-head" role="button" tabindex="0" aria-controls="logBody">
          <span class="chev">▶</span> Log
        </div>
        <div id="logBody" class="log-body">
          <pre id="logPre">{}</pre>
        </div>
      </div>
    </section>
  </main>

  <script>
    // --- Data ---------------------------------------------------------------
    const CATEGORIES = [
      "Comp Acquisition","Expl G&A","Expl G&G","Expl Drilling Success","Appr Drilling Success",
      "Dev G&A","Dev Drilling Success","Facilities","Buildings","Machinery and Equipment",
      "Platforms","Plants and Gathering","Pipelines","Abandonment"
    ];

    // Leaves incl. Gas + WAG variants (kept for safety)
    const LEAVES = [
      // Wells
      "Oil Production Wells","Gas Production Wells","Water Injection Wells","Gas Injection Wells","WAG Injection Wells",
      // Drilling Centers
      "Oil Production Drilling Centers","Gas Production Drilling Centers","Water Injection Drilling Centers","Gas Injection Drilling Centers","WAG Injection Drilling Centers",
      // Gathering Units
      "FPSO Spread Moored Gathering Units",
      // Flowlines
      "Oil Production Flowlines","Gas Production Flowlines","Water Injection Flowlines","Gas Injection Flowlines","WAG Injection Flowlines",
      // Risers
      "Oil Production Risers","Gas Production Risers","Water Injection Risers","Gas Injection Risers","WAG Injection Risers",
      // Riser Bases
      "Oil Production Riser Bases","Gas Production Riser Bases","Water Injection Riser Bases","Gas Injection Riser Bases","WAG Injection Riser Bases"
    ];

    const TOTALS_SECOND_LEVEL = [
      "Total Wells","Total Drilling Centers","Total Gathering Units",
      "Total Flowlines","Total Risers","Total Riser Bases","Total Tie-In Points"
    ];

    // Default PEEP-style category suggestions for totals
    const DEFAULT_TOTAL_CATEGORY = {
      "Total Wells": "Dev Drilling Success",
      "Total Drilling Centers": "Facilities",
      "Total Gathering Units": "Plants and Gathering",
      "Total Flowlines": "Pipelines",
      "Total Risers": "Pipelines",
      "Total Riser Bases": "Facilities",
      "Total Tie-In Points": "Facilities"
    };

    const ALL_KEYS = ["Total Capex", ...TOTALS_SECOND_LEVEL, ...LEAVES];

    // Map totals → children (unsorted; sorted at render)
    const CHILDREN = {
      "Total Wells": [
        "Oil Production Wells","Gas Production Wells","Water Injection Wells","Gas Injection Wells","WAG Injection Wells"
      ],
      "Total Drilling Centers": [
        "Oil Production Drilling Centers","Gas Production Drilling Centers","Water Injection Drilling Centers","Gas Injection Drilling Centers","WAG Injection Drilling Centers"
      ],
      "Total Gathering Units": [
        "FPSO Spread Moored Gathering Units"
      ],
      "Total Flowlines": [
        "Oil Production Flowlines","Gas Production Flowlines","Water Injection Flowlines","Gas Injection Flowlines","WAG Injection Flowlines"
      ],
      "Total Risers": [
        "Oil Production Risers","Gas Production Risers","Water Injection Risers","Gas Injection Risers","WAG Injection Risers"
      ],
      "Total Riser Bases": [
        "Oil Production Riser Bases","Gas Production Riser Bases","Water Injection Riser Bases","Gas Injection Riser Bases","WAG Injection Riser Bases"
      ],
      "Total Tie-In Points": []
    };

    // --- State --------------------------------------------------------------
    const state = {
      checked: new Set(),
      disabled: new Set(),
      mapping: new Map(),
    };

    // --- DOM refs -----------------------------------------------------------
    const treeEl = document.getElementById("tree");
    const mapBody = document.getElementById("mapBody");
    const errorsEl = document.getElementById("errors");
    const downloadBtn = document.getElementById("downloadBtn");
    const resetBtn = document.getElementById("resetBtn");
    const selCountEl = document.getElementById("selCount");
    const logEl = document.getElementById("log");
    const logHead = document.getElementById("logHead");
    const logPre = document.getElementById("logPre");

    // --- Helpers ------------------------------------------------------------
    function kindPriority(name){
      if(/Oil Production/.test(name)) return 0;
      if(/Gas Production/.test(name)) return 1;
      if(/Water Injection/.test(name)) return 2;
      if(/Gas Injection/.test(name)) return 3;
      if(/WAG Injection/.test(name)) return 4;
      return 50;
    }
    function sortChildren(list){
      return [...list].sort((a,b)=>{
        const da = kindPriority(a), db = kindPriority(b);
        if(da !== db) return da - db;
        return a.localeCompare(b);
      });
    }

    // --- Build tree UI (with collapsible groups) ---------------------------
    function createNode(key, level){
      const id = `cb-${key.replace(/\s+/g,'-').toLowerCase()}`;
      const wrap = document.createElement("div");
      wrap.className = `node lvl-${level}`;
      wrap.dataset.key = key;

      const cb = document.createElement("input");
      cb.type = "checkbox"; cb.id = id; cb.dataset.key = key;

      const label = document.createElement("label");
      label.htmlFor = id; label.textContent = key; label.title = key;

      cb.addEventListener("change", () => onToggle(key, cb.checked));
      wrap.append(cb, label);
      return wrap;
    }

    function createGroup(total){
      const group = document.createElement("div");
      group.className = "group";
      group.dataset.total = total;
      group.setAttribute("aria-expanded","false"); // collapsed by default

      // Header row (lvl-1) with chevron
      const header = createNode(total, 1);
      const twisty = document.createElement("span");
      twisty.className = "twisty";
      twisty.setAttribute("role","button");
      twisty.setAttribute("tabindex","0");
      twisty.setAttribute("aria-label",`Toggle ${total}`);
      twisty.textContent = "▶";
      twisty.addEventListener("click", ()=> toggleGroup(group));
      twisty.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" || e.key === " "){ e.preventDefault(); toggleGroup(group); }
      });
      header.prepend(twisty); // chevron before checkbox
      group.append(header);

      // Children container
      const childrenWrap = document.createElement("div");
      childrenWrap.className = "children";
      const kids = sortChildren(CHILDREN[total] || []);
      for(const leaf of kids){
        childrenWrap.append(createNode(leaf, 2));
      }
      group.append(childrenWrap);
      return group;
    }

    function toggleGroup(groupEl){
      const expanded = groupEl.getAttribute("aria-expanded") === "true";
      groupEl.setAttribute("aria-expanded", String(!expanded));
    }

    function renderTree(){
      treeEl.innerHTML = "";

      // Level 0: Total Capex (no children)
      treeEl.append(createNode("Total Capex", 0));

      // Level 1 totals: groups if they have children, otherwise plain node
      for(const total of TOTALS_SECOND_LEVEL){
        const kids = CHILDREN[total] || [];
        if(kids.length){
          treeEl.append(createGroup(total));
        } else {
          treeEl.append(createNode(total, 1));
        }
      }

      // Any leaf not covered above (safety; not collapsed)
      const covered = new Set(Object.values(CHILDREN).flat());
      const orphans = LEAVES.filter(k => !covered.has(k));
      for(const orphan of sortChildren(orphans)){
        treeEl.append(createNode(orphan, 2));
      }
    }

    // --- Logic --------------------------------------------------------------
    function onToggle(key, isChecked){
      if(isChecked){ state.checked.add(key); }
      else{
        state.checked.delete(key);
        state.mapping.delete(key);
      }
      recomputeDisabled();
      renderMapping();
      refreshUI();
    }

    function recomputeDisabled(){
      state.disabled.clear();
      const totalCapexOn = state.checked.has("Total Capex");

      if(totalCapexOn){
        for(const k of ALL_KEYS){ if(k!=="Total Capex") state.disabled.add(k); }
      } else {
        for(const t of Object.keys(CHILDREN)){
          if(t === "Total Capex") continue;
          if(state.checked.has(t)){
            for(const child of CHILDREN[t] || []) state.disabled.add(child);
          }
        }
      }

      // Ensure disabled items are not selected
      for(const k of state.disabled){
        if(state.checked.has(k)){
          state.checked.delete(k);
          state.mapping.delete(k);
        }
      }
    }

    function renderMapping(){
      mapBody.innerHTML = "";
      const selected = Array.from(state.checked);

      if(selected.length === 0){
        mapBody.innerHTML = `<tr><td colspan="2" class="hint">Select items on the left to begin.</td></tr>`;
        downloadBtn.disabled = true;
        selCountEl.textContent = "0 selected";
        updatePreview();
        return;
      }

      const totals = selected.filter(k => k.startsWith("Total "));
      const others = selected.filter(k => !k.startsWith("Total "));
      const ordered = [...totals, ...others];

      selCountEl.textContent = `${selected.length} selected`;

      for(const key of ordered){
        const tr = document.createElement("tr");

        const tdLabel = document.createElement("td");
        tdLabel.textContent = key;
        tr.appendChild(tdLabel);

        const tdSelect = document.createElement("td");
        const sel = document.createElement("select");
        sel.dataset.key = key;
        sel.append(new Option("— Select a category —",""));
        for(const cat of CATEGORIES){ sel.append(new Option(cat, cat)); }
        const current = state.mapping.get(key) || "";
        sel.value = current;
        sel.addEventListener("change", e=>{
          const v = e.target.value;
          if(v) state.mapping.set(key, v); else state.mapping.delete(key);
          validate(); updatePreview();
        });
        tdSelect.appendChild(sel);
        tr.appendChild(tdSelect);

        mapBody.appendChild(tr);
      }

      validate();
      updatePreview();
    }

    function validate(){
      const selected = Array.from(state.checked);
      const missing = selected.filter(k => !state.mapping.has(k));
      errorsEl.textContent = missing.length ? `Choose a category for: ${missing.join(", ")}` : "";
      downloadBtn.disabled = missing.length > 0 || selected.length === 0;
    }

    // --- Log (JSON preview) -------------------------------------------------
    function updatePreview(){
      const obj = {};
      for(const k of state.checked){
        obj[k] = state.mapping.has(k) ? state.mapping.get(k) : null;
      }
      logPre.textContent = JSON.stringify(obj, null, 2);
    }

    function toggleLog(){
      const expanded = logEl.getAttribute("aria-expanded") === "true";
      logEl.setAttribute("aria-expanded", String(!expanded));
    }
    logHead.addEventListener("click", toggleLog);
    logHead.addEventListener("keydown", (e)=>{ if(e.key === "Enter" || e.key === " "){ e.preventDefault(); toggleLog(); } });

    // --- Actions ------------------------------------------------------------
    downloadBtn.addEventListener("click", ()=>{
      const obj = {};
      for(const k of state.checked){ obj[k] = state.mapping.get(k); }
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "cost-mapping.json";
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    });

    resetBtn.addEventListener("click", initDefaults); // restore defaults

    // --- UI sync ------------------------------------------------------------
    function refreshUI(){
      const selected = new Set(state.checked);
      const disabled = new Set(state.disabled);
      for(const node of treeEl.querySelectorAll(".node")){
        const key = node.dataset.key;
        const cb = node.querySelector("input[type=checkbox]");
        const wasChecked = cb.checked;
        cb.checked = selected.has(key);
        cb.disabled = disabled.has(key);
        node.classList.toggle("disabled", cb.disabled);
        if(wasChecked && cb.disabled){ cb.checked = false; }
      }
    }

    // --- Defaults -----------------------------------------------------------
    function initDefaults(){
      state.checked.clear();
      state.disabled.clear();
      state.mapping.clear();

      // Pre-check all second-level totals and set default categories
      for(const t of TOTALS_SECOND_LEVEL){
        state.checked.add(t);
        if(DEFAULT_TOTAL_CATEGORY[t]) state.mapping.set(t, DEFAULT_TOTAL_CATEGORY[t]);
      }

      recomputeDisabled();
      refreshUI();
      renderMapping();

      // Collapse all groups on init/reset
      for(const g of treeEl.querySelectorAll(".group")){
        g.setAttribute("aria-expanded","false");
      }

      logEl.setAttribute("aria-expanded","false");
      updatePreview();
    }

    // --- Init ---------------------------------------------------------------
    renderTree();
    initDefaults();
  </script>
</body>
</html>
